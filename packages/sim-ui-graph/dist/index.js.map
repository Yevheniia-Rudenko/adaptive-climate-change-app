{"version":3,"sources":["../src/graph-view.ts","../src/impl/view-impl-bar.ts","../src/impl/view-impl-line.ts"],"sourcesContent":["// Copyright (c) 2020-2022 Climate Interactive / New Venture Fund. All rights reserved.\n\nimport type { ChartConfiguration, ChartData, ChartOptions } from 'chart.js'\nimport { Chart } from 'chart.js'\nimport ChartAnnotations from 'chartjs-plugin-annotation'\n\nimport type { OutputVarId, StringKey } from '@climateinteractive/sim-core'\n\nimport type { GraphBox, GraphViewModel, GraphViewOptions } from './graph-vm'\nimport type { GraphAxisStyle, GraphFontStyle, GraphStyle } from './graph-style'\nimport { barChartJsConfig, createBarChartJsData, updateBarChartJsData } from './impl/view-impl-bar'\nimport {\n  createLineChartJsData,\n  lineChartJsConfig,\n  updateLineChartJsData\n} from './impl/view-impl-line'\n\n// Enable the annotation plugins, which can be configured for specific charts\nChart.plugins.register(ChartAnnotations)\n\n/**\n * Wraps a native chart element.\n */\nexport class GraphView {\n  private readonly tooltipsAvailable: boolean\n  private chart: Chart\n\n  constructor(\n    readonly canvas: HTMLCanvasElement,\n    readonly viewModel: GraphViewModel,\n    options: GraphViewOptions,\n    tooltipsEnabled: boolean\n  ) {\n    if (viewModel.spec.kind === 'h-bar') {\n      this.tooltipsAvailable = viewModel.spec.legendItems[0].labelKey.indexOf('today') >= 0\n    } else {\n      this.tooltipsAvailable = true\n    }\n    this.chart = createChart(canvas, viewModel, options, this.tooltipsAvailable && tooltipsEnabled)\n  }\n\n  /**\n   * Set whether animations should be enabled.\n   *\n   * Note that if you want to disable animations entirely, it is better to\n   * set `animations` to false in `GraphViewOptions` to avoid initializing\n   * animation support in the underlying chart library.  This method is mainly\n   * useful in cases where animations are disabled initially but you want to\n   * enable them later.\n   */\n  setAnimationsEnabled(enabled: boolean): void {\n    if (this.chart) {\n      // Note: The \"enabled\" values below are the documented default values\n      // for Chart.js 2.9.4\n      this.chart.options.animation = { duration: enabled ? 1000 : 0 }\n      this.chart.options.hover = { animationDuration: enabled ? 400 : 0 }\n      this.chart.options.responsiveAnimationDuration = 0\n      this.chart.update()\n    }\n  }\n\n  /**\n   * Set whether tooltips should be displayed.  This has no effect on\n   * graph types (e.g. bar graphs) for which tooltips are always disabled.\n   */\n  setTooltipsEnabled(enabled: boolean): void {\n    if (this.tooltipsAvailable && this.chart) {\n      this.chart.options.tooltips.enabled = enabled\n      this.chart.update()\n    }\n  }\n\n  /**\n   * Update all labels to use the appropriate translated strings.\n   * This should be called after the current locale/language has\n   * changed to ensure that the labels are updated.  This will also\n   * cause the chart to refresh its ticks and tooltips to use\n   * the correct locale-specific formatting based on the current\n   * locale value.\n   */\n  updateLabels(): void {\n    if (this.chart) {\n      const graphSpec = this.viewModel.spec\n      const xAxisLabel = stringForKey(this.viewModel, graphSpec.xAxisLabelKey)\n      const yAxisLabel = stringForKey(this.viewModel, graphSpec.yAxisLabelKey)\n      this.chart.config.options.scales.xAxes[0].scaleLabel.labelString = xAxisLabel\n      this.chart.config.options.scales.yAxes[0].scaleLabel.labelString = yAxisLabel\n      this.chart.config.data.labels = getDatasetLabels(this.viewModel)\n      this.chart.update()\n    }\n  }\n\n  /**\n   * Update the chart to reflect the latest data from the model.\n   * This should be called after the model has produced new outputs.\n   *\n   * @param animated Whether to animate the data when it is updated.\n   */\n  updateData(animated = true): void {\n    if (this.chart) {\n      // Update the chart data\n      if (this.viewModel.spec.kind === 'h-bar') {\n        updateBarChartJsData(this.viewModel, this.chart.data, this.chart.options)\n      } else {\n        updateLineChartJsData(this.viewModel, this.chart.data)\n      }\n\n      if (this.viewModel.getHighlightedDataset?.() !== undefined) {\n        // XXX: Force hide any tooltip.  This works around an issue where if you quickly\n        // hover over a plot and then hover over a legend item before the plot tooltip\n        // has fully faded out, Chart.js will continue to show the tooltip when the\n        // legend hover animation is in progress.  The downside of this is that we\n        // need to disable animation for the `update` call for the tooltip to be hidden\n        // immediately, which means that the highlight fade-in effect won't be animated\n        // and will instead occur immediately.\n        if (this.chart.options.tooltips.enabled) {\n          this.chart.options.tooltips.enabled = false\n          this.chart.update({ duration: 0 })\n          setTimeout(() => {\n            this.chart.options.tooltips.enabled = true\n          }, 10)\n        }\n      }\n\n      // Refresh the chart view\n      this.chart.update(animated ? undefined : { duration: 0 })\n    }\n  }\n\n  /**\n   * Destroy the chart and any associated resources.\n   */\n  destroy(): void {\n    this.chart?.destroy()\n    this.chart = undefined\n  }\n}\n\n/** @hidden */\nfunction createChart(\n  canvas: HTMLCanvasElement,\n  viewModel: GraphViewModel,\n  options: GraphViewOptions,\n  tooltipsEnabled: boolean\n): Chart {\n  // Create the chart data and config depending on the given style\n  const style = options.style || {}\n  let chartData: ChartData\n  let chartJsConfig: ChartConfiguration\n  if (viewModel.spec.kind === 'h-bar') {\n    // Initialize a horizontal bar graph\n    chartData = createBarChartJsData(viewModel.spec)\n    chartJsConfig = barChartJsConfig(viewModel, chartData, tooltipsEnabled)\n    updateBarChartJsData(viewModel, chartData, chartJsConfig.options)\n  } else {\n    // Initialize a line (or stacked line) graph\n    chartData = createLineChartJsData(viewModel)\n    chartJsConfig = lineChartJsConfig(viewModel, options, chartData, tooltipsEnabled)\n    updateLineChartJsData(viewModel, chartData)\n  }\n\n  if (options.animations === false) {\n    // Disable all built-in animations.  Note that we allow animations to be disabled\n    // at init time to prevent Chart.js from initializing animation code.  This helps\n    // avoid problems seen in some browsers where rendering many graphs at once may\n    // cause slowness or hangs.\n    chartJsConfig.options.animation = { duration: 0 }\n    chartJsConfig.options.hover = { animationDuration: 0 }\n    chartJsConfig.options.responsiveAnimationDuration = 0\n  }\n\n  if (options.responsive !== false) {\n    // Use built-in responsive resizing support.  Note that for this to work\n    // correctly, the canvas parent must be a container with a fixed size\n    // (in `px` or `vw` units) and `position: relative`.  For more information:\n    //   https://www.chartjs.org/docs/2.9.4/general/responsive.html\n    chartJsConfig.options.responsive = true\n  } else {\n    // Disable built-in responsive resizing support\n    chartJsConfig.options.responsive = false\n  }\n  chartJsConfig.options.maintainAspectRatio = false\n\n  // Disable the built-in title and legend\n  chartJsConfig.options.title = { display: false }\n  chartJsConfig.options.legend = { display: false }\n\n  // Don't show points\n  chartJsConfig.options.elements = {\n    point: {\n      radius: 0\n    }\n  }\n\n  // Set the initial (translated) axis labels\n  const graphSpec = viewModel.spec\n  const xAxisLabel = stringForKey(viewModel, graphSpec.xAxisLabelKey)\n  const yAxisLabel = stringForKey(viewModel, graphSpec.yAxisLabelKey)\n  chartJsConfig.options.scales.xAxes[0].scaleLabel.labelString = xAxisLabel\n  chartJsConfig.options.scales.yAxes[0].scaleLabel.labelString = yAxisLabel\n  chartJsConfig.data.labels = getDatasetLabels(viewModel)\n\n  // Apply the font options for labels and ticks.  Note that we apply these\n  // to all axis configurations, even the ones that have labels hidden, because\n  // Chart.js takes labels into account (hidden or not) when calculating the\n  // sizes of chart elements, and we need to make sure the sizes are aligned\n  // for all axes (especially for making the stacked-with-ref-line code work).\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  function applyFontOptions(obj: any | undefined, axisFontStyle: GraphFontStyle | undefined) {\n    if (!obj) {\n      return\n    }\n    if (style.font?.family) {\n      obj.fontFamily = style.font.family\n    }\n    if (axisFontStyle?.family) {\n      obj.fontFamily = axisFontStyle.family\n    }\n    if (style.font?.style) {\n      obj.fontStyle = style.font.style\n    }\n    if (axisFontStyle?.style) {\n      obj.fontStyle = axisFontStyle.style\n    }\n    if (style.font?.color) {\n      obj.fontColor = style.font.color\n    }\n    if (axisFontStyle?.color) {\n      obj.fontColor = axisFontStyle.color\n    }\n  }\n  function applyFontOptionsForAxis(\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    chartAxis: any | undefined,\n    axisStyle: GraphAxisStyle | undefined\n  ) {\n    applyFontOptions(chartAxis.scaleLabel, axisStyle?.axisLabelFont)\n    applyFontOptions(chartAxis.ticks, axisStyle?.tickLabelFont)\n  }\n  chartJsConfig.options.scales.xAxes.forEach(axis => applyFontOptionsForAxis(axis, style.xAxis))\n  chartJsConfig.options.scales.yAxes.forEach(axis => applyFontOptionsForAxis(axis, style.yAxis))\n  if (viewModel.spec.kind === 'h-bar') {\n    type FontOptions = {\n      family: string\n      style: string\n    }\n    const fontOptions = chartJsConfig.options.plugins.datalabels.font as FontOptions\n    if (style.font) {\n      fontOptions.family = style.font.family\n      fontOptions.style = style.font.style\n    }\n  }\n\n  // Apply the font options for tooltips; note that we leave the color\n  // as the default because the tooltip background is dark by default\n  // and we don't have a separate option yet for controlling the tooltip\n  // text color separately from label colors\n  if (style.font) {\n    chartJsConfig.options.tooltips.titleFontFamily = style.font.family\n    chartJsConfig.options.tooltips.titleFontStyle = style.font.style\n    chartJsConfig.options.tooltips.bodyFontFamily = style.font.family\n    chartJsConfig.options.tooltips.bodyFontStyle = style.font.style\n  }\n\n  // Keep track of the current chart area and only notify when the\n  // box values are changing.  (There doesn't seem to be a single\n  // reliable callback for this, so we use both `afterLayout` and\n  // `resize` callbacks.)\n  let currentBox: GraphBox = {\n    left: 0,\n    top: 0,\n    bottom: 0,\n    right: 0,\n    yMin: 0,\n    yMax: 0\n  }\n  function notifyResizedIfNeeded(chart: Chart): void {\n    // Note that the graph could either be configured with a yMin/Max or a ySoftMin/Max.\n    // In the latter case, the actual displayed min/max will vary at runtime, so we\n    // need to grab the current value from the Chart.js metadata.\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const yAxisScale = (chart as any).scales['y-axis-0']\n    const yMin = yAxisScale?.min\n    const yMax = yAxisScale?.max\n\n    const area = chart.chartArea\n    const box: GraphBox = {\n      left: area.left,\n      top: area.top,\n      right: area.right,\n      bottom: area.bottom,\n      yMin,\n      yMax\n    }\n\n    if (\n      box.left !== currentBox.left ||\n      box.top !== currentBox.top ||\n      box.right !== currentBox.right ||\n      box.bottom !== currentBox.bottom ||\n      box.yMin !== currentBox.yMin ||\n      box.yMax !== currentBox.yMax\n    ) {\n      currentBox = box\n      viewModel.onResize?.(box)\n    }\n  }\n\n  // Apply scale factors (based on the window width) to the font\n  // size and line width after the chart is initialized and after\n  // each resize event\n  if (!chartJsConfig.plugins) {\n    chartJsConfig.plugins = []\n  }\n  chartJsConfig.plugins.push({\n    afterLayout: chart => {\n      applyScaleFactors(viewModel, style, chart.options, chartData)\n      notifyResizedIfNeeded(chart)\n    },\n    resize: chart => {\n      applyScaleFactors(viewModel, style, chart.options, chartData)\n      notifyResizedIfNeeded(chart)\n    },\n    afterDatasetsDraw: chart => {\n      // XXX: This plugin is currently only used for rendering the special\n      // NDC \"bar\".  This sizing is calculated to make the bar centered in\n      // 2030, with y=\"center\" and h=\"range\" (defined in `Constants.dat`).\n      if (viewModel.spec.id !== '62') {\n        return\n      }\n      const datasetViewModels = viewModel.getDatasets()\n      const ndcVarId = '_all_countries_follow_ndcs'\n      const ndcDataset = (varId: string) => datasetViewModels.find(d => d.spec.varId === varId)\n      const ndcConstant = (varId: OutputVarId) => {\n        const dataset = ndcDataset(varId)\n        if (dataset === undefined || dataset.visible === false) {\n          return undefined\n        }\n        return dataset.points[0].y\n      }\n      const ndcRangeLo = ndcConstant(ndcVarId + '_range_low')\n      const ndcRangeHi = ndcConstant(ndcVarId + '_range_high')\n      if (ndcRangeLo === undefined || ndcRangeHi === undefined) {\n        return\n      }\n      const a = chart.chartArea\n      const chartW = a.right - a.left\n      const chartH = a.bottom - a.top\n      // Note that the graph could either be configured with a yMin/Max or a ySoftMin/Max.\n      // In the latter case, the actual displayed min/max will vary at runtime, so we\n      // need to grab the current value from the Chart.js metadata.\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      const yAxisScale = (chart as any).scales['y-axis-0']\n      const yMin = yAxisScale.min\n      const yMax = yAxisScale.max\n      const barPctH = (ndcRangeHi - ndcRangeLo) / (yMax - yMin)\n      const boxW = chartW * 0.02\n      const boxH = chartH * barPctH\n      const boxX = a.left + chartW * ((2030 - 2000) / (2100 - 2000)) - boxW * 0.5\n      const boxY = a.bottom - chartH * ((ndcRangeLo - yMin) / (yMax - yMin)) - boxH\n      chart.ctx.fillStyle = ndcDataset(ndcVarId).spec.color\n      fillRoundRect(chart.ctx, boxX, boxY, boxW, boxH, boxW * 0.4)\n    }\n  })\n\n  return new Chart(canvas, chartJsConfig)\n}\n\n/** @hidden */\nfunction fillRoundRect(\n  ctx: CanvasRenderingContext2D,\n  x: number,\n  y: number,\n  w: number,\n  h: number,\n  r: number\n): void {\n  if (w < 2 * r) r = w / 2\n  if (h < 2 * r) r = h / 2\n  ctx.beginPath()\n  ctx.moveTo(x + r, y)\n  ctx.arcTo(x + w, y, x + w, y + h, r)\n  ctx.arcTo(x + w, y + h, x, y + h, r)\n  ctx.arcTo(x, y + h, x, y, r)\n  ctx.arcTo(x, y, x + w, y, r)\n  ctx.closePath()\n  ctx.fill()\n}\n\n/** @hidden */\nfunction applyScaleFactors(\n  viewModel: GraphViewModel,\n  style: GraphStyle,\n  options: ChartOptions,\n  chartData: ChartData\n): void {\n  const datasetViewModels = viewModel.getDatasets()\n  const datasetCount = datasetViewModels.length\n\n  if (style.getTickLabelFontSize) {\n    // Adjust the size of tick marks and labels.  The tick mark length is adjusted\n    // in proportion to the font size.  Note that we scale labels for all axes,\n    // even the ones that have labels hidden (see note for `applyFontOptions`).\n    // XXX: We decrease the font size slightly in this one case to accommodate\n    // the \"Probability of ice-free Arctic summer\" label on one line\n    const scaleFactor = viewModel.spec.id === '141' ? 0.9 : 1.0\n    const scaleFontSizeInPx = style.getTickLabelFontSize() * scaleFactor\n    const scaleTickSizeInPx = scaleFontSizeInPx * 0.6\n    for (const axis of [...options.scales.xAxes, ...options.scales.yAxes]) {\n      axis.ticks.fontSize = scaleFontSizeInPx\n      axis.gridLines.tickMarkLength = scaleTickSizeInPx\n    }\n\n    // Adjust the tooltip font size as a percentage of the tick font size\n    const tooltipFontSizeInPx = scaleFontSizeInPx * 0.9\n    options.tooltips.titleFontSize = tooltipFontSizeInPx\n    options.tooltips.bodyFontSize = tooltipFontSizeInPx\n  }\n\n  if (style.getAxisLabelFontSize) {\n    // Adjust the size of axis labels\n    const axisFontSizeInPx = style.getAxisLabelFontSize()\n    for (const axis of [...options.scales.xAxes, ...options.scales.yAxes]) {\n      axis.scaleLabel.fontSize = axisFontSizeInPx\n    }\n    if (viewModel.spec.kind === 'h-bar') {\n      type FontOptions = {\n        size: number\n      }\n      const fontOptions = options.plugins.datalabels.font as FontOptions\n      // XXX: Need to use a different font size depending on whether we are showing\n      // many bars or few bars\n      const scaleFactor = datasetCount <= 8 ? 1.4 : 0.8\n      fontOptions.size = axisFontSizeInPx * scaleFactor\n      options.plugins.datalabels.padding = axisFontSizeInPx * 0.15\n    }\n  }\n\n  // The rest of the styling applies only to line graphs, so return early if this\n  // a different kind of graph\n  if (viewModel.spec.kind !== 'line' && viewModel.spec.kind !== 'stacked-line') {\n    return\n  }\n\n  // Scale the line widths\n  const lineWidthInPx = style.getDefaultLineWidth ? style.getDefaultLineWidth() : 12\n  for (let datasetIndex = 0; datasetIndex < datasetCount; datasetIndex++) {\n    const datasetSpec = datasetViewModels[datasetIndex].spec\n    const chartDataset = chartData.datasets[datasetIndex]\n\n    if (style.getDatasetStyle) {\n      // Use the customized values provided by the style\n      const datasetStyle = style.getDatasetStyle(datasetSpec, lineWidthInPx)\n      if (datasetStyle.lineWidth !== undefined) {\n        chartDataset.borderWidth = datasetStyle.lineWidth\n      }\n      if (datasetStyle.lineDash !== undefined) {\n        chartDataset.borderDash = datasetStyle.lineDash\n      }\n      if (datasetStyle.pointRadius !== undefined) {\n        chartDataset.pointRadius = datasetStyle.pointRadius\n        // Make the `pointHoverRadius` equal to the `pointRadius` to prevent unwanted\n        // hover effects\n        chartDataset.pointHoverRadius = chartDataset.pointRadius\n      }\n      // TODO: Add `pointStyle` to `GraphDatasetStyle`\n    } else {\n      // Compute values based on the provided (or default) line width\n      const lineStyle = datasetSpec.lineStyle\n      switch (lineStyle) {\n        case 'dashed': {\n          const dashLengthInPx = lineWidthInPx * 1.2\n          const dashSpaceInPx = lineWidthInPx * 1.7\n          chartDataset.borderDash = [dashLengthInPx, dashSpaceInPx]\n          chartDataset.borderWidth = lineWidthInPx * 0.35\n          break\n        }\n        case 'dotted': {\n          const dotSizeInPx = 0.2\n          const dotSpaceInPx = lineWidthInPx * 2\n          chartDataset.borderDash = [dotSizeInPx, dotSpaceInPx]\n          chartDataset.borderWidth = lineWidthInPx * 0.6\n          break\n        }\n        case 'thinline':\n          chartDataset.borderWidth = lineWidthInPx * 0.35\n          break\n        case '2px_line':\n          chartDataset.borderWidth = lineWidthInPx * 0.2\n          break\n        case 'scatter':\n          // XXX: This scatter style is currently only used for rendering the special\n          // \"NDC pledge\" bar.  We use a tiny point size so that the tooltip shows up,\n          // but the actual scatter point is hidden from view in those cases where\n          // it might otherwise be visible when the y axis range is changing.  The\n          // actual rendering of the bar happens in `afterDatasetsDraw`.\n          chartDataset.pointRadius = 0.0001\n          break\n        case 'none':\n          // The special 'none' line style is used to define a point that is referenced\n          // by another plot, like in the case of the \"NDC pledge\" bar or the upper/lower\n          // range area on the \"Temperature History\" graph (using the 'fill-to-next'\n          // style modifier).  In this case, we don't want any line to appear (so don't\n          // set `borderWidth`), and we want `point[Hit]Radius` to be zero so that the\n          // point does not trigger tooltips.\n          chartDataset.borderWidth = undefined\n          chartDataset.pointRadius = undefined\n          break\n        case 'line':\n        default:\n          chartDataset.borderWidth = lineWidthInPx\n          break\n      }\n\n      const pointModifier = datasetSpec.lineStyleModifiers?.find(mod => mod.startsWith('show-'))\n      if (pointModifier !== undefined) {\n        let defaultRadius: number\n        switch (pointModifier) {\n          case 'show-diamond':\n            chartDataset.pointStyle = 'rectRot'\n            defaultRadius = lineWidthInPx * 0.6\n            break\n          case 'show-triangle':\n            chartDataset.pointStyle = 'triangle'\n            defaultRadius = lineWidthInPx * 0.7\n            break\n          case 'show-dot':\n          default:\n            chartDataset.pointStyle = 'circle'\n            defaultRadius = lineWidthInPx * 0.5\n            break\n        }\n        if (chartDataset.borderWidth !== undefined) {\n          // If `borderWidth` is defined, the line is shown in addition to the point; make the point\n          // be roughly twice as wide as the line by default.  This can be customized by implementing\n          // the `getDatasetStyle` function instead.\n          chartDataset.pointRadius = (chartDataset.borderWidth as number) * 1.5\n        } else {\n          // For scatter plots, set a default point size that depends on the point style\n          chartDataset.pointRadius = defaultRadius\n        }\n        // Make the `pointHoverRadius` equal to the `pointRadius` to prevent unwanted hover effects\n        chartDataset.pointHoverRadius = chartDataset.pointRadius\n      }\n    }\n\n    // Set the border width for points to zero (overriding the default value of 1) so that we only\n    // show the background/fill color\n    chartDataset.pointBorderWidth = 0\n\n    // The \"hit radius\" is the size in pixels of the non-displayed point that reacts to mouse/hover\n    // events.  The default value is 1, which is very small and makes it difficult to precisely\n    // hover over a data point to show a tooltip.  We override the hit radius for all line and\n    // scatter plots so that the point size is roughly 2 times the width of the default (thick)\n    // line style, which makes it easier to hover without needing to be precise with the mouse.\n    if (chartDataset.borderWidth !== undefined || chartDataset.pointRadius !== undefined) {\n      chartDataset.pointHitRadius = lineWidthInPx * 0.8\n    }\n  }\n}\n\n// Labels can either be a single string, or an array of strings (which will\n// be rendered by chart.js with one string per line)\ntype DatasetLabel = string | string[]\n\n/** @hidden */\nfunction getDatasetLabels(viewModel: GraphViewModel): DatasetLabel[] {\n  if (viewModel.spec.kind === 'h-bar') {\n    // Note that there are two dataset specs for each pair of bars, one for Baseline\n    // and one for Current Scenario, so we only need one label for each pair\n    const datasetViewModels = viewModel.getDatasets()\n    const datasetsForLabels = datasetViewModels.filter((_, index) => index % 2 === 0)\n    return datasetsForLabels.map(datasetViewModel => {\n      // The label strings can include an explicit line break (`<br>`) to\n      // allow long labels to wrap to a second line\n      const label = viewModel.getStringForKey(datasetViewModel.spec.labelKey)\n      if (label.includes('<br>')) {\n        return label.split('<br>')\n      } else {\n        return label\n      }\n    })\n  } else {\n    return []\n  }\n}\n\n/** @hidden */\nfunction stringForKey(viewModel: GraphViewModel, key?: StringKey): string | undefined {\n  if (key) {\n    return viewModel.getStringForKey(key)\n  } else {\n    return undefined\n  }\n}\n","// Copyright (c) 2021-2022 Climate Interactive / New Venture Fund. All rights reserved.\n\nimport type { ChartConfiguration, ChartData, ChartOptions } from 'chart.js'\nimport Chart from 'chart.js'\nimport type { BoxAnnotationOptions } from 'chartjs-plugin-annotation'\nimport ChartDataLabels from 'chartjs-plugin-datalabels'\n\nimport type { GraphSpec, HexColor, Point } from '@climateinteractive/sim-core'\n\nimport type { GraphViewModel } from '../graph-vm'\n\n// Custom tooltip positioner so that the tooltip on the impact graph points to the\n// \"Today\" annotation line\nChart.Tooltip.positioners.barToday = function (elements) {\n  // eslint-disable-next-line @typescript-eslint/no-this-alias, @typescript-eslint/no-explicit-any\n  const tooltip: any = this\n  const datasetIndex = elements[0]._index\n  const annotationId = `line${datasetIndex}`\n  const annotationElements = tooltip._chart.annotation.elements\n  const annotationKey = Object.keys(annotationElements).find(elem => elem.startsWith(annotationId))\n  if (annotationKey) {\n    const annotation = tooltip._chart.annotation.elements[annotationKey]._model\n    return {\n      x: annotation.right,\n      y: annotation.top + (annotation.bottom - annotation.top) * 0.5\n    }\n  } else {\n    return undefined\n  }\n}\n\n/** @hidden */\nexport function barChartJsConfig(\n  viewModel: GraphViewModel,\n  data: ChartData,\n  tooltipsEnabled: boolean\n): ChartConfiguration {\n  const spec = viewModel.spec\n\n  function formatValue(value: number): string {\n    // TODO: Consider adding a separate function on GraphViewModel for data value formatting\n    return viewModel.formatYAxisTickValue(value)\n  }\n\n  return {\n    type: 'horizontalBar',\n    data,\n    plugins: [ChartDataLabels],\n    options: {\n      plugins: {\n        datalabels: {\n          color: 'black',\n          align: 'end',\n          anchor: 'end',\n          font: {\n            // XXX: This is a hack for adjusting the vertical position of the label\n            // relative to the center of the bar; it relies on the string having a\n            // prepended newline.  Based on the following comment:\n            //   https://github.com/chartjs/chartjs-plugin-datalabels/issues/153#issuecomment-724070514\n            lineHeight: 0.15\n          },\n          formatter: value => {\n            // XXX: See comment for `lineHeight` above regarding the newline here\n            return `\\n${formatValue(value)}`\n          }\n        }\n      },\n      scales: {\n        xAxes: [\n          {\n            id: 'bar-x-0',\n            scaleLabel: {\n              display: false\n            },\n            ticks: {\n              maxTicksLimit: 2,\n              display: false,\n              beginAtZero: true\n            },\n            gridLines: {\n              display: false\n            }\n          }\n        ],\n        yAxes: [\n          {\n            id: 'bar-y-0',\n            scaleLabel: {\n              display: false\n            },\n            ticks: {\n              display: true\n            },\n            gridLines: {\n              display: false\n            }\n          }\n        ]\n      },\n      tooltips: {\n        enabled: tooltipsEnabled,\n        position: 'barToday',\n        titleMarginBottom: 0,\n        callbacks: {\n          title: function (tooltipItems) {\n            const options = this._chart.options\n            if (tooltipItems.length > 0) {\n              const datasetIndex = tooltipItems[0].index\n              const todayValue = options.annotation.annotations[datasetIndex].xMin\n              // TODO: This is specific to the impact graphs; need to generalize\n              const todayLabelKey = spec.legendItems[0].labelKey\n              const todayLabel = viewModel.getStringForKey(todayLabelKey)\n              return `${todayLabel}: ${formatValue(todayValue)}`\n            } else {\n              return ''\n            }\n          },\n          label: () => {\n            return ''\n          }\n        }\n      }\n    }\n  }\n}\n\n/** @hidden */\nexport function createBarChartJsData(spec: GraphSpec): ChartData {\n  // Make the bar color match the color specified for the legend items\n  const itemCount = spec.legendItems.length\n  const baselineColor = spec.legendItems[itemCount - 2].color\n  const currentColor = spec.legendItems[itemCount - 1].color\n\n  // Set a minimum length so that the bar shows as a thin sliver when\n  // the value goes to zero\n  const minBarLength = 2\n\n  return {\n    datasets: [\n      {\n        backgroundColor: baselineColor,\n        hoverBackgroundColor: baselineColor,\n        minBarLength\n      },\n      {\n        backgroundColor: currentColor,\n        hoverBackgroundColor: currentColor,\n        minBarLength\n      }\n    ]\n  }\n}\n\n/** @hidden */\nexport function updateBarChartJsData(\n  viewModel: GraphViewModel,\n  chartData: ChartData,\n  options: ChartOptions\n): void {\n  function getValueAtTime(points: Point[], year: number): number {\n    // This is typically called with 2100 (or the current year), so search from the end\n    // of the array\n    let point: Point\n    for (let i = points.length - 1; i >= 0; i--) {\n      if (points[i].x === year) {\n        point = points[i]\n        break\n      }\n    }\n    // Use abs to make negative change values positive, and display as a positive value\n    return Math.abs(point?.y || 0)\n  }\n\n  function rgba(hexColor: HexColor, alpha: number): string {\n    if (alpha === 1) {\n      return hexColor\n    }\n    const r = parseInt(hexColor.substring(1, 3), 16)\n    const g = parseInt(hexColor.substring(3, 5), 16)\n    const b = parseInt(hexColor.substring(5, 7), 16)\n    return `rgba(${r},${g},${b},${alpha})`\n  }\n\n  // Note that there are two dataset specs for each pair of bars, one for Baseline\n  // and one for Current Scenario\n  const datasetViewModels = viewModel.getDatasets()\n  const datasetCount = datasetViewModels.length\n  const groupCount = datasetCount / 2\n  const currentYear = new Date().getFullYear()\n  const todayValues: number[] = []\n  const baseline2100Values: number[] = []\n  const current2100Values: number[] = []\n  for (let datasetIndex = 0; datasetIndex < datasetCount; datasetIndex++) {\n    const datasetViewModel = datasetViewModels[datasetIndex]\n    const datasetSpec = datasetViewModel.spec\n    const datasetPoints = datasetViewModel.points\n    if (datasetSpec.externalSourceName === 'Ref') {\n      todayValues.push(getValueAtTime(datasetPoints, currentYear))\n      baseline2100Values.push(getValueAtTime(datasetPoints, 2100))\n    } else {\n      current2100Values.push(getValueAtTime(datasetPoints, 2100))\n    }\n  }\n  chartData.datasets[0].data = baseline2100Values\n  chartData.datasets[1].data = current2100Values\n\n  // Apply highlights if needed\n  const highlightedDatasetSpec = viewModel.getHighlightedDataset?.()\n  const highlightActive = highlightedDatasetSpec !== undefined\n  const legendItems = viewModel.spec.legendItems\n  const itemCount = legendItems.length\n  const baselineColor = legendItems[itemCount - 2].color\n  const currentColor = legendItems[itemCount - 1].color\n  for (let i = 0; i <= 1; i++) {\n    const chartDataset = chartData.datasets[i]\n    const datasetColor = i === 1 ? currentColor : baselineColor\n    if (highlightActive) {\n      // One of the datasets is actively being highlighted.  If this dataset is\n      // not the highlighted one, dim it by adjusting the alpha value.\n      const highlighted =\n        (i === 0 && highlightedDatasetSpec.externalSourceName === 'Ref') ||\n        (i === 1 && highlightedDatasetSpec.externalSourceName === undefined)\n      const alpha = highlighted ? 1.0 : 0.1\n      chartDataset.backgroundColor = rgba(datasetColor, alpha)\n    } else {\n      // There is no active highlight, so restore original color\n      chartDataset.backgroundColor = datasetColor\n    }\n  }\n\n  // Dynamically adjust the max value to accommodate the longest bar and leave some\n  // extra room for the data label\n  const max = (values: number[]) => {\n    let maxValue = 0\n    for (const v of values) {\n      if (v > maxValue) {\n        maxValue = v\n      }\n    }\n    return maxValue\n  }\n  const maxBaselineValue = max(baseline2100Values)\n  const maxCurrentValue = max(current2100Values)\n  let maxValue: number\n  if (maxCurrentValue > maxBaselineValue) {\n    // In the less common case where the current scenario values are larger\n    // than the baseline values, set a max that is significantly larger than\n    // the max baseline value.  This helps avoid having the baseline (black)\n    // bar appear to move when the current scenario (blue) bar is pushing up\n    // against the upper limits of the graph.  There will be a noticeable jump\n    // (once) when the threshold is crossed, but the max will appear to hold\n    // for as long as the current value is on one side of the baseline value.\n    if (maxCurrentValue > maxBaselineValue * 1.1) {\n      maxValue = maxCurrentValue\n    } else {\n      maxValue = maxBaselineValue\n    }\n  } else {\n    // In the more common case where the baseline values are greater than\n    // the current scenario values, use the max baseline value as the guide\n    maxValue = maxBaselineValue\n  }\n  options.scales.xAxes[0].ticks.max = maxValue * 1.3\n\n  // Update the annotations, if needed; this is done on every update in case\n  // we need to adjust the line to account for the bar length\n  const showTodayLine = viewModel.spec.legendItems.length === 3\n  if (showTodayLine) {\n    options.annotation = {\n      annotations: []\n    }\n    // TODO: Fix thickness so that it's consistent across all charts\n    const thickness = options.scales.xAxes[0].ticks.max * 0.005\n    // TODO: This is specific to the impact graphs; need to generalize\n    const todayColor = viewModel.spec.legendItems[0].color\n    for (let groupIndex = 0; groupIndex < groupCount; groupIndex++) {\n      const current2100Value = current2100Values[groupIndex]\n      const todayValue = todayValues[groupIndex]\n      const full = current2100Value >= todayValue\n      options.annotation.annotations.push(line(groupIndex, todayValue, thickness, todayColor, full))\n    }\n  }\n}\n\n// Use a unique identifier for all annotations; this is needed to ensure that\n// the annotation plugin re-renders the annotation when its parameters change.\nlet annotationId = 1\n\n/** @hidden */\nfunction line(\n  index: number,\n  x: number,\n  thickness: number,\n  color: HexColor,\n  full: boolean\n): BoxAnnotationOptions {\n  // When `full` is true, draw the line the across both bars with overhang at the ends,\n  // but when `full` is false (i.e., when the current scenario value is nearing or\n  // going below the today value), draw the line across the baseline bar only to avoid\n  // colliding with the data label\n  const extent = 0.45\n  const yMin = index - extent\n  const yMax = full ? index + extent : index + 0.05\n  return {\n    type: 'box',\n    id: `line${index}-${annotationId++}`,\n    drawTime: 'afterDatasetsDraw',\n    xScaleID: 'bar-x-0',\n    yScaleID: 'bar-y-0',\n    xMin: x,\n    xMax: x + thickness,\n    yMin,\n    yMax,\n    backgroundColor: color,\n    borderColor: 'rgba(0, 0, 0, 0)',\n    borderWidth: 0.01\n  }\n}\n","// Copyright (c) 2021-2022 Climate Interactive / New Venture Fund. All rights reserved.\n\nimport type {\n  ChartConfiguration,\n  ChartData,\n  ChartDataSets,\n  ChartPoint,\n  PluginServiceRegistrationOptions\n} from 'chart.js'\nimport { Chart } from 'chart.js'\n\nimport type { GraphSpec, HexColor, Point } from '@climateinteractive/sim-core'\n\nimport type { GraphViewModel, GraphViewOptions } from '../graph-vm'\n\nconst TRANSPARENT = 'rgba(0, 0, 0, 0)'\n\nconst currentYear = new Date().getFullYear()\n\n/** @hidden */\nexport function lineChartJsConfig(\n  viewModel: GraphViewModel,\n  options: GraphViewOptions,\n  data: ChartData,\n  tooltipsEnabled: boolean\n): ChartConfiguration {\n  const spec = viewModel.spec\n\n  const style = options.style || {}\n  const xStyle = style.xAxis || {}\n  const yStyle = style.yAxis || {}\n\n  // XXX: For the \"Temperature History\" graph in En-ROADS that goes from 1990 to 2022,\n  // Chart.js will draw overlapping x-axis tick labels for 2020 and 2022.  We detect\n  // this case and provide a custom callback that hides the 2020 label but keeps the\n  // tick and grid line intact.\n  let xTickCallback: (value: number) => number | string\n  if (spec.xMin === 1990 && spec.xMax > 2020 && spec.xMax < 2030) {\n    xTickCallback = (value: number) => {\n      return value !== 2020 ? value : ''\n    }\n  }\n\n  const plugins: PluginServiceRegistrationOptions[] = []\n  if (options?.tooltipMode === 'vertical-line') {\n    // Enable a custom tooltip positioner that moves the tooltip to the mouse event location\n    // (useful when a vertical line is used to show all data points for the hovered year)\n    if (Chart.Tooltip.positioners.custom === undefined) {\n      Chart.Tooltip.positioners.custom = function (elements, eventPosition) {\n        if (elements?.length === 0) {\n          return { x: 0, y: 0 }\n        }\n\n        // Position the tooltip to the left of the vertical line in most cases, except\n        // when the mouse is near the left edge of the chart area (in which case we\n        // position the tooltip to the right of the line)\n        const chart = elements[0]._chart\n        const chartArea = chart.chartArea\n        const chartW = chartArea.right - chartArea.left\n        // TODO: These offset/limit values need to take the chart size into account\n        const xOffset = eventPosition.x > chartArea.left + chartW * 0.2 ? -50 : 50\n        const x = eventPosition.x + xOffset\n        const y = Math.min(Math.max(eventPosition.y, chartArea.top + 10), chartArea.bottom - 10)\n        return {\n          x,\n          y\n        }\n      }\n    }\n\n    // Enable a custom plugin that draws a vertical line for the current year when\n    // the custom tooltip positioner is enabled\n    plugins.push({\n      afterDraw: chart => {\n        // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n        // @ts-ignore\n        const tooltip = chart.tooltip\n        if (tooltip?._active === undefined || tooltip._active.length === 0) {\n          // Don't draw the vertical line when the tooltip isn't visible\n          return\n        }\n\n        const chartArea = chart.chartArea\n        const x = tooltip._eventPosition.x\n        if (x < chartArea.left || x > chartArea.right) {\n          // Don't draw the vertical line when the event is outside the chart area\n          return\n        }\n\n        const ctx = chart.ctx\n        ctx.save()\n        ctx.beginPath()\n        ctx.moveTo(x, chartArea.top)\n        ctx.lineTo(x, chartArea.bottom)\n        ctx.lineWidth = 1\n        ctx.strokeStyle = 'rgba(0, 0, 0, 0.2)'\n        ctx.stroke()\n        ctx.restore()\n      }\n    })\n  }\n\n  const chartConfig: ChartConfiguration = {\n    type: 'line',\n    data,\n    options: {\n      scales: {\n        xAxes: [\n          {\n            id: 'x1',\n            type: 'linear',\n            position: 'bottom',\n            scaleLabel: {\n              display: xStyle.axisLabelVisible !== false && spec.xAxisLabelKey !== undefined,\n              padding: {\n                top: 0,\n                bottom: 5\n              }\n            },\n            ticks: {\n              display: xStyle.tickLabelsVisible !== false,\n              maxRotation: 0,\n              min: spec.xMin,\n              max: spec.xMax,\n              ...(xStyle.tickMaxCount !== undefined && {\n                maxTicksLimit: xStyle.tickMaxCount\n              }),\n              ...(xTickCallback && {\n                callback: xTickCallback\n              }),\n              // When `showCurrentYear` is enabled, show a smaller subset of ticks\n              ...(options.showCurrentYear && {\n                stepSize: 1,\n                autoSkip: false,\n                callback: value => {\n                  const ticks = [2000, currentYear, 2050, 2075, 2100]\n                  return ticks.indexOf(value as number) >= 0 ? value : undefined\n                }\n              })\n            },\n            gridLines: {\n              display: xStyle.gridLinesVisible !== false,\n              // TODO: Add style option\n              // drawOnChartArea: false,\n              color: xStyle.gridLineColor || 'rgba(0, 0, 0, 0.1)',\n              drawTicks: xStyle.tickLinesVisible !== false\n            }\n          }\n        ],\n        yAxes: [\n          {\n            afterFit: scale => {\n              if (yStyle.tickAreaScale !== undefined) {\n                scale.width *= yStyle.tickAreaScale\n              }\n            },\n            scaleLabel: {\n              display: yStyle.axisLabelVisible !== false && spec.yAxisLabelKey !== undefined\n            },\n            ticks: {\n              display: yStyle.tickLabelsVisible !== false,\n              maxTicksLimit: yStyle.tickMaxCount,\n              beginAtZero: true,\n              min: spec.yMin,\n              max: spec.yMax,\n              suggestedMin: spec.ySoftMin,\n              suggestedMax: spec.ySoftMax,\n              callback: value => {\n                return viewModel.formatYAxisTickValue(value as number)\n              }\n            },\n            gridLines: {\n              display: yStyle.gridLinesVisible !== false,\n              // TODO: Add style option\n              // drawOnChartArea: false,\n              color: xStyle.gridLineColor || 'rgba(0, 0, 0, 0.1)',\n              zeroLineColor: xStyle.gridLineColor || 'rgba(0, 0, 0, 0.25)',\n              drawTicks: yStyle.tickLinesVisible !== false\n            },\n            stacked: isStacked(spec)\n          }\n        ]\n      },\n      tooltips: {\n        enabled: tooltipsEnabled,\n        filter: tooltipItem => {\n          // Only show the tooltip for data points that are in the visible range\n          if (spec.xMin !== undefined && spec.xMax !== undefined) {\n            const x = tooltipItem.xLabel as number\n            return x >= spec.xMin && x <= spec.xMax\n          } else {\n            return true\n          }\n        },\n        callbacks: {\n          label: tooltipItem => {\n            return viewModel.formatYAxisTooltipValue(tooltipItem.yLabel as number)\n          }\n        },\n        ...(options.tooltipMode === 'vertical-line' && {\n          intersect: false,\n          mode: 'index',\n          position: 'custom',\n          // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n          // @ts-ignore\n          yAlign: 'right'\n        })\n      }\n    },\n    plugins\n  }\n\n  if (options.showCurrentYear) {\n    // Add a secondary x-axis to support drawing dashed line for current year\n    chartConfig.options.scales.xAxes.push({\n      id: 'x2',\n      type: 'linear',\n      position: 'bottom',\n      scaleLabel: {\n        display: false\n      },\n      ticks: {\n        display: false,\n        maxRotation: 0,\n        min: spec.xMin,\n        max: spec.xMax,\n        stepSize: 1,\n        autoSkip: false,\n        callback: value => {\n          return value === currentYear ? value : undefined\n        }\n      },\n      gridLines: {\n        display: xStyle.gridLinesVisible !== false,\n        color: '#ddd',\n        borderDash: [5, 5],\n        drawBorder: false,\n        drawTicks: false\n      }\n    })\n  }\n\n  if (isStackedWithRefLine(spec)) {\n    // For stacked charts that include a reference line, append a secondary style that will\n    // be used to display the ref line.\n    chartConfig.options.scales.yAxes.push({\n      id: 'stacked-ref-line',\n      display: false,\n      scaleLabel: {\n        display: false\n      },\n      ticks: {\n        display: false,\n        beginAtZero: true,\n        min: spec.yMin,\n        max: spec.yMax,\n        suggestedMin: spec.ySoftMin,\n        suggestedMax: spec.ySoftMax\n      },\n      stacked: false\n    })\n  }\n\n  return chartConfig\n}\n\n/** @hidden */\nexport function createLineChartJsData(viewModel: GraphViewModel): ChartData {\n  const graphSpec = viewModel.spec\n  const datasetViewModels = viewModel.getDatasets()\n  const datasetCount = datasetViewModels.length\n  const stacked = isStacked(viewModel.spec)\n  const chartDatasets: ChartDataSets[] = []\n\n  for (let datasetIndex = 0; datasetIndex < datasetCount; datasetIndex++) {\n    const chartDataset: ChartDataSets = {}\n\n    const datasetViewModel = datasetViewModels[datasetIndex]\n    const datasetSpec = datasetViewModel.spec\n    const color = datasetViewModel.color || datasetSpec.color\n    const lineStyle = datasetSpec.lineStyle\n    const lineStyleModifiers = datasetSpec.lineStyleModifiers\n    if (stacked && lineStyle === 'area') {\n      // This is an area section of a stacked chart; display it with fill style\n      // and disable the border (which would otherwise make the section appear\n      // larger than it should be, and would cause misalignment with the ref line).\n      chartDataset.fill = true\n      chartDataset.borderColor = TRANSPARENT\n      chartDataset.backgroundColor = color\n    } else if (lineStyle === 'scatter') {\n      // This is a scatter plot.  We configure the chart type and dot color here,\n      // but the point radius will be configured in `applyScaleFactors`.\n      chartDataset.type = 'scatter'\n      chartDataset.fill = false\n      chartDataset.borderColor = TRANSPARENT\n      chartDataset.backgroundColor = color\n    } else {\n      // This is a line plot. Always specify a background color even if fill is\n      // disabled; this ensures that the color square is correct for tooltips.\n      chartDataset.backgroundColor = color\n      if (lineStyleModifiers?.indexOf('fill-to-next') >= 0) {\n        // This is the first line in a confidence interval; fill the area between\n        // this dataset and the one that follows\n        chartDataset.fill = '+1'\n      } else {\n        // This is a normal line plot; no fill\n        chartDataset.fill = false\n      }\n      if (lineStyle === 'none') {\n        // Make the line transparent (typically only used for confidence intervals)\n        chartDataset.borderColor = TRANSPARENT\n      } else {\n        // Use the specified color for the line\n        chartDataset.borderColor = color\n        chartDataset.borderCapStyle = 'round'\n      }\n    }\n\n    if (stacked && lineStyle !== 'area') {\n      // This is a ref line for a stacked chart; configure it to use the alternate\n      // `stacked-ref-line` y axis style, and set the order to -1 (the default is 0)\n      // so that it is displayed above the stacked chart (in terms of z-order).\n      chartDataset.yAxisID = 'stacked-ref-line'\n      chartDataset.order = -1\n    }\n\n    if (lineStyleModifiers?.indexOf('straight') >= 0) {\n      // Use straight line segments instead of the default curved segments\n      chartDataset.lineTension = 0\n    }\n\n    if (lineStyleModifiers?.indexOf('order-top') >= 0) {\n      // Display this dataset on top of the others by setting the order to -1 (the\n      // default is 0)\n      // TODO: This is used in cases where we want the data to appear on top but\n      // have the legend item appear last.  (Normally datasets that come first are\n      // on top, and their legend item appears first.)  Currently this works well\n      // when there's only one dataset that uses 'order-top'; if we want to support\n      // more than one, perhaps use decreasing order values here.\n      chartDataset.order = -1\n    } else {\n      // If one of the numbered `order-N` modifiers is present, set the order\n      // value accordingly\n      const orderModifier = lineStyleModifiers?.find(m => m.startsWith('order-'))\n      if (orderModifier) {\n        switch (orderModifier) {\n          case 'order-1':\n            chartDataset.order = 1\n            break\n          case 'order-2':\n            chartDataset.order = 2\n            break\n          case 'order-3':\n            chartDataset.order = 3\n            break\n          default:\n            break\n        }\n      }\n    }\n\n    chartDataset.pointHoverRadius = 0\n    if (lineStyle === 'none') {\n      // Prevent showing tooltips for plots with line style of \"none\".  This is\n      // primarily helpful in the case of the \"NDC pledge\" bar, where it may be\n      // confusing to show the tooltip for the lower and upper points of the range).\n      chartDataset.pointHitRadius = 0\n    } else {\n      // Show tooltips for all other kinds of plots\n      chartDataset.pointHitRadius = 3\n    }\n\n    // Save the original color and order values so that they can be adjusted later\n    // if the dataset is highlighted or dimmed\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const customChartDataset = chartDataset as any\n    if (chartDataset.borderColor !== TRANSPARENT) {\n      customChartDataset.origBorderColor = chartDataset.borderColor\n    }\n    if (chartDataset.fill !== false) {\n      customChartDataset.origBackgroundColor = chartDataset.backgroundColor\n    }\n    customChartDataset.origOrder = chartDataset.order\n\n    chartDatasets.push(chartDataset)\n  }\n\n  if (stacked && isStackedWithRefLine(graphSpec)) {\n    // In the case of a stacked chart that contains a reference line, we\n    // configure the chart so that it has two y axis scales, one for the\n    // stacked lines and one for the ref line.  We normally let Chart.js\n    // automatically scale the chart to keep the lines visible, but that\n    // autoscaling doesn't take the secondary y-axis scale into account.\n    // To make sure both scales are kept in sync, we add two special datasets,\n    // each of which holds a single hidden point (one using the default y-axis\n    // scale, the other using the `stacked-ref-line` y-axis scale).  The point\n    // contains the maximum y value of the stacked graph datasets (see\n    // `updateLineChartJsData` and `getStackedMaxY`).\n    if (graphSpec.yMax === undefined && graphSpec.ySoftMax === undefined) {\n      // This approach currently assumes that either a `yMax` or `ySoftMax`\n      // is defined in the GraphSpec, so if that is not the case, treat it\n      // as a runtime error\n      // TODO: This should also be caught at build time\n      let msg = 'Stacked graphs containing a ref line must have a defined yMax or ySoftMax'\n      msg += ` (id=${graphSpec.id})`\n      throw new Error(msg)\n    }\n    const addHiddenScatterPoint = (yAxisId?: string) => {\n      const chartDataset: ChartDataSets = {}\n      chartDataset.yAxisID = yAxisId\n      chartDataset.type = 'scatter'\n      chartDataset.fill = false\n      chartDataset.borderColor = TRANSPARENT\n      chartDataset.backgroundColor = TRANSPARENT\n      chartDataset.pointHitRadius = 0\n      chartDataset.pointHoverRadius = 0\n      chartDataset.pointRadius = 0\n      chartDataset.data = [{ x: 2100, y: 0 }]\n      chartDatasets.push(chartDataset)\n    }\n    addHiddenScatterPoint(undefined)\n    addHiddenScatterPoint('stacked-ref-line')\n  }\n\n  return {\n    datasets: chartDatasets\n  }\n}\n\n/** @hidden */\nexport function updateLineChartJsData(viewModel: GraphViewModel, chartData: ChartData): void {\n  const datasetViewModels = viewModel.getDatasets()\n  const datasetCount = datasetViewModels.length\n  const highlightedDatasetSpec = viewModel.getHighlightedDataset?.()\n  const highlightActive = highlightedDatasetSpec !== undefined\n  for (let datasetIndex = 0; datasetIndex < datasetCount; datasetIndex++) {\n    // Get the view model and spec for this dataset\n    const datasetViewModel = datasetViewModels[datasetIndex]\n    const datasetSpec = datasetViewModel.spec\n    const chartDataset = chartData.datasets[datasetIndex]\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const customChartDataset = chartDataset as any\n    const varId = datasetSpec.varId\n    const sourceName = datasetSpec.externalSourceName\n\n    // Update the data points for this dataset\n    chartDataset.data = datasetViewModel.points\n\n    // Apply the custom opacity for this dataset, if defined\n    if (datasetViewModel.opacity !== undefined) {\n      const opacity = datasetViewModel.opacity\n      // XXX: Chart.js seems to have a bug where wrong color is selected if\n      // multiple plots have opacity < 1\n      const origColor = datasetViewModel.color || datasetViewModel.spec.color\n      const color = deriveWithOpacity(origColor, opacity)\n      chartDataset.borderColor = color\n    }\n\n    // Set the visibility of the dataset\n    chartDataset.hidden = datasetViewModel.visible === false\n\n    // Update the highlight state for the dataset\n    if (highlightActive) {\n      // One of the datasets is actively being highlighted.  If this dataset is\n      // not the highlighted one, dim it by blending it with white.  Note that we\n      // don't simply adjust the opacity/alpha of the dataset color because we don't\n      // want to have the plots be translucent (which looks confusing in the case of\n      // line datasets, and just plain wrong in the case of stacked datasets due to\n      // the way that Chart.js renders each stacked dataset).\n      const highlighted =\n        highlightedDatasetSpec?.varId === varId &&\n        highlightedDatasetSpec?.externalSourceName == sourceName\n      const alpha = highlighted ? 1.0 : 0.2\n      if (customChartDataset.origBorderColor) {\n        chartDataset.borderColor = blendWithWhite(customChartDataset.origBorderColor, alpha)\n      }\n      if (customChartDataset.origBackgroundColor) {\n        chartDataset.backgroundColor = blendWithWhite(customChartDataset.origBackgroundColor, alpha)\n      }\n      // XXX: Note that we bring the highlighted plot to the front only in the case of\n      // non-stacked (line) graphs.  Without this conditional here, Chart.js attempts\n      // to re-order the plots based on the order value, and this would produce the\n      // wrong results.\n      if (highlighted && !isStacked(viewModel.spec)) {\n        chartDataset.order = -10\n      } else {\n        chartDataset.order = customChartDataset.origOrder\n      }\n    } else {\n      // There is no active highlight, so restore the overridden or original color and order\n      const overriddenColor = datasetViewModel.color\n      if (customChartDataset.origBorderColor) {\n        chartDataset.borderColor = overriddenColor || customChartDataset.origBorderColor\n      }\n      if (customChartDataset.origBackgroundColor) {\n        chartDataset.backgroundColor = overriddenColor || customChartDataset.origBackgroundColor\n      }\n      chartDataset.order = customChartDataset.origOrder\n    }\n  }\n\n  if (isStackedWithRefLine(viewModel.spec)) {\n    // Update the special datasets that hold the max y value for the\n    // stacked dataset (see `createLineChartJsData` for more details)\n    const yMax = getStackedMaxY(viewModel.spec, chartData)\n    const updateHiddenScatterPoint = (index: number) => {\n      const point = chartData.datasets[index].data[0] as ChartPoint\n      point.y = yMax\n    }\n    updateHiddenScatterPoint(datasetCount)\n    updateHiddenScatterPoint(datasetCount + 1)\n  }\n}\n\n/** @hidden */\nfunction deriveWithOpacity(hexColor: HexColor, opacity: number): string {\n  const r = parseInt(hexColor.substring(1, 3), 16)\n  const g = parseInt(hexColor.substring(3, 5), 16)\n  const b = parseInt(hexColor.substring(5, 7), 16)\n  return `rgba(${r}, ${g}, ${b}, ${opacity})`\n}\n\n/** @hidden */\nfunction blendWithWhite(hexColor: HexColor, alpha: number): string {\n  if (alpha === 1) {\n    return hexColor\n  }\n\n  // Convert a hex component value to a number in the range [0,1]\n  function convert(start: number, end: number): number {\n    return parseInt(hexColor.substring(start, end), 16) / 255\n  }\n\n  // Mix an RGB component value (in the range [0,1]) with white and convert\n  // back to the [0,255] range\n  function mix(src: number): number {\n    // This is basically a \"source over\" blending operation\n    const premultipliedSrc = src * alpha\n    const premultipliedDst = 1\n    const result = premultipliedSrc + premultipliedDst * (1 - alpha)\n    return Math.round(result * 255)\n  }\n\n  // Mix the components individually and return a CSS `rgb()` color string\n  const r = mix(convert(1, 3))\n  const g = mix(convert(3, 5))\n  const b = mix(convert(5, 7))\n  return `rgb(${r},${g},${b})`\n}\n\n/** @hidden */\nfunction isStacked(spec: GraphSpec): boolean {\n  // A graph that includes a plot with a line style of area is a stacked graph.\n  // Note that other plot line styles are ignored, except for the special case\n  // where a ref line is specified (with a line style other than 'area').\n  return spec.kind === 'stacked-line'\n}\n\n/** @hidden */\nfunction isStackedWithRefLine(spec: GraphSpec): boolean {\n  // A chart that includes a plot with a non-'area' line style (and for which\n  // `isStackedChart` returns true) is a stacked chart with a ref line.  The\n  // ref line is displayed with a line style on top of the stacked chart.\n  return isStacked(spec) && spec.datasets.some(d => d.lineStyle !== 'area')\n}\n\n/**\n * Find the maximum y value for the stacked graph datasets.\n *\n * This is only needed for the stacked-with-ref-line graphs.  This should\n * only be called after calling `updateChartJsData` since it relies on the\n * latest chart data.\n *\n * @hidden\n */\nfunction getStackedMaxY(spec: GraphSpec, chartData: ChartData): number {\n  // Determine the sum of the stacked lines at each x\n  // TODO: This is pretty inefficient, would be better to reduce allocations\n  const stackedTotals: Map<number, number> = new Map()\n  const varCount = spec.datasets.length\n  let refMaxY = 0\n  for (let varIndex = 0; varIndex < varCount; varIndex++) {\n    const lineStyle = spec.datasets[varIndex].lineStyle\n    const data = chartData.datasets[varIndex].data as Point[]\n    switch (lineStyle) {\n      case 'area':\n        // Sum the stacked lines at each x\n        for (const point of data) {\n          const sum = stackedTotals.get(point.x) ?? 0\n          stackedTotals.set(point.x, sum + point.y)\n        }\n        break\n      case '2px_line':\n      case 'dashed':\n      case 'dotted':\n      case 'line':\n      case 'scatter':\n      case 'none':\n      case 'thinline':\n        // Find the maximum y value for the ref line\n        for (const point of data) {\n          refMaxY = Math.max(refMaxY, point.y)\n        }\n        break\n      default:\n        throw new Error('Unhandled ref line style for stacked graph')\n    }\n  }\n\n  // Compute the maximum y value for the stacked dataset\n  let maxY = 0\n  for (const stackedY of stackedTotals.values()) {\n    maxY = Math.max(maxY, stackedY)\n  }\n\n  // Compute the overall maximum y value for the stacked and ref line datasets\n  maxY = Math.max(maxY, refMaxY)\n\n  return maxY\n}\n"],"mappings":"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","names":["Chart","annotationId","currentYear","maxValue","Chart","Chart","Chart"]}